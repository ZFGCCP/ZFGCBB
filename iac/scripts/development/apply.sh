#!/bin/bash
set -e

# Check if there are no arguments
if [ $# -eq 0 ]; then
    cat <<EOF
Usage: $0 <project-directory> <environment>

Example: $0 "./zfgc.com" "development"
EOF
    exit 1
fi

PROJECT_DIR=$1
PROJECT_ENVIRONMENT=$2

SCRIPT_DIR=$(dirname "$0")
source "$SCRIPT_DIR/../common/check-minikube.sh"
source "$SCRIPT_DIR/../common/check-project-dir.sh"

check_project_dir "$PROJECT_DIR" "$PROJECT_ENVIRONMENT"
check_minikube

cd "$PROJECT_DIR/environments/$PROJECT_ENVIRONMENT"

source ./.env
source ./.env.secret

export $(cut -d= -f1 ./.env)
export $(cut -d= -f1 ./.env.secret)

kubectl kustomize . -v 9 | envsubst

echo ""
echo "Press any key to continue..."
read -n 1 -s
clear

echo "
           █████████████████████████████████████████████████████            █████████               
           █████████████████████████████████████████████████████            █████████               
       ████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█████████████▓▓▓▓████               
       ████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█████████████▓▓▓▓████               
       ████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█████████████▓▓▓▓████               
           ████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓████               
           ████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓████               
               █████▓▓▓▓▓▓▓▓▓▓▓▓████░░░░▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓████               
               █████▓▓▓▓▓▓▓▓▓▓▓▓████░░░░▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓████               
                   █████▓▓▓▓▓▓▓▓████░░░░░░░░▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓████               
                   █████▓▓▓▓▓▓▓▓████░░░░░░░░▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓████               
                        ████▓▓▓▓████░░░░▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓████           
                        ████▓▓▓▓████░░░░▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓████           
                        ████▓▓▓▓████░░░░▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓████           
                   █████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓            ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓████           
                   █████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓            ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓████           
               █████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓                    ▒▓▓▓▓▓▓▓▓▓▓▓▓████           
               █████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓                    ▒▓▓▓▓▓▓▓▓▓▓▓▓████           
           ████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓                ████▓▓▓▓▒    ████               
           ████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓                ████▓▓▓▓▒    ████               
       █████████████████████████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓                ████▓▓▓▓▒    ████               
       █████████████████████████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓                ████▓▓▓▓▒    ████               
                        ████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓            ████░   ▒████████████           
                        ████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓            ████░   ▒████████████           
                        ████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓            ████░   ▒████████████           
                   █████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓░░░░░░░░░░░░            ░░░░░░░░░░░░░████               
                   █████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓░░░░░░░░░░░░            ░░░░░░░░░░░░░████               
               █████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░████               
               █████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░████               
           █████████████████████████████████████░░░░░░░░░░░░░░░░░░░░░░░░░░░░▒████                   
           █████████████████████████████████████░░░░░░░░░░░░░░░░░░░░░░░░░░░░▒████                   
                                        ████░░░░█████████████████████████████████                   
                                        ████░░░░█████████████████████████████████                   
                                        ████░░░░█████████████████████████████████                   
                                    ████░░░░████████▓▓▓▓░░░░░░░░░░░░█████████████████               
                                    ████░░░░████████▓▓▓▓░░░░░░░░░░░░█████████████████               
                                ████░░░░████        ████░░░░░░░░░░░░████░        ████               
                                ████░░░░████        ████░░░░░░░░░░░░████░        ████               
                                ████████                ████░░░░░░░░████░        ████               
                                ████████                ████░░░░░░░░████░        ████               
                                    ████                ████████░░░░████░   ▒████                   
                                    ████                ████████░░░░████░   ▒████                   
                                        ████        ████████▓▓▓▓█████████████████                   
                                        ████        ████████▓▓▓▓█████████████████                   
                                        ████        ████████▓▓▓▓█████████████████                   
                                            ████████▓▓▓▓████████████                                
                                            ████████▓▓▓▓████████████                                
                                            ████████▓▓▓▓████▓▓▓▓▓▓▓▓█████████                       
                                            ████████▓▓▓▓████▓▓▓▓▓▓▓▓█████████                       
                                        ████████▓▓▓▓▓▓▓▓████████▓▓▓▓▓▓▓▓░   ▒████████               
                                        ████████▓▓▓▓▓▓▓▓████████▓▓▓▓▓▓▓▓░   ▒████████               
                                        ████▓▓▓▓▓▓▓▓▓▓▓▓    ▓▓▓▓████████▓▓▓▓▓▓▓▓▓▓▓▓▓████           
                                        ████▓▓▓▓▓▓▓▓▓▓▓▓    ▓▓▓▓████████▓▓▓▓▓▓▓▓▓▓▓▓▓████           
                                        ████▓▓▓▓▓▓▓▓▓▓▓▓    ▓▓▓▓████████▓▓▓▓▓▓▓▓▓▓▓▓▓████           
                                        ████▓▓▓▓▓▓▓▓    ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█████▓▓▓▓▓▓▓▓▓▓▓▓████       
                                        ████▓▓▓▓▓▓▓▓    ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█████▓▓▓▓▓▓▓▓▓▓▓▓████       
                                        █████████████████████████████████████████████████████       
                                        █████████████████████████████████████████████████████       
                                                                                                    
"

echo "Applying kustomize build..."

# Use envsubst to replace environment variables in the kustomization.yml file
kustomize build . | envsubst | kubectl apply -f -
cd -

echo "Deployments have been applied."